<?xml version="1.0" encoding="utf-8" ?>
<ContentPage
    x:Class="AppPallet.Views.PresupuestoMostrarView"
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:converters="clr-namespace:AppPallet.Converters"
    xmlns:fa="clr-namespace:UraniumUI.Icons.FontAwesome;assembly=UraniumUI.Icons.FontAwesome"
    xmlns:material="http://schemas.enisn-projects.io/dotnet/maui/uraniumui/material"
    xmlns:models="clr-namespace:AppPallet.Models"
    xmlns:uranium="http://schemas.enisn-projects.io/dotnet/maui/uraniumui"
    xmlns:viewModels="clr-namespace:AppPallet.ViewModels"
    Title="{Binding Titulo}"
    x:DataType="viewModels:PresupuestoMostrarViewModel"
    Shell.NavBarIsVisible="False">

    <ContentPage.Resources>
        <converters:NullToZeroConverter x:Key="NullToZeroConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*">
        <!-- Header -->
        <Border Grid.Row="0" Stroke="Black">
            <Grid BackgroundColor="#374151" ColumnDefinitions="*,Auto" Padding="20,15">
                <Label
                    Grid.Column="0"
                    FontAttributes="Bold"
                    FontSize="24"
                    HorizontalOptions="Start"
                    Text="{Binding Titulo}"
                    TextColor="#F6F1EB"
                    VerticalOptions="Center" />

                <HorizontalStackLayout
                    Grid.Column="1"
                    Spacing="10"
                    HorizontalOptions="End"
                    VerticalOptions="Center">
                    <Label
                        FontSize="14"
                        Text="Filtrar:"
                        TextColor="White"
                        VerticalOptions="Center" />
                    <material:PickerField
                        x:Name="MesPicker"
                        Padding="8,5"
                        AccentColor="White"
                        AllowClear="False"
                        BorderColor="White"
                        InputBackgroundColor="#F6F1EB"
                        ItemsSource="{Binding FiltroMeses}"
                        SelectedIndex="{Binding MesIngresado, Mode=TwoWay}"
                        TextColor="White"
                        WidthRequest="130" />
                    <material:PickerField
                        x:Name="AÃ±oPicker"
                        Padding="8,5"
                        AccentColor="White"
                        AllowClear="False"
                        BorderColor="White"
                        InputBackgroundColor="#F6F1EB"
                        ItemsSource="{Binding FiltroAÃ±os}"
                        SelectedItem="{Binding AÃ±oIngresado, Mode=TwoWay}"
                        TextColor="White"
                        WidthRequest="100" />
                </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- No hay Presupuestos -->
        <Border Grid.Row="1" IsVisible="{Binding NoHayPresu}" Padding="20">
            <VerticalStackLayout
                HorizontalOptions="Center"
                Spacing="15"
                VerticalOptions="Center">
                <Label
                    FontSize="48"
                    HorizontalTextAlignment="Center"
                    Text="ðŸ“‹" />
                <Label
                    FontSize="16"
                    HorizontalTextAlignment="Center"
                    Text="No se encontraron presupuestos para esta fecha o empresa"
                    TextColor="#9CA3AF" />
            </VerticalStackLayout>
        </Border>

        <!-- Presupuestos -->
        <ScrollView Grid.Row="1" Padding="20,15">
            <CollectionView ItemsSource="{Binding Resultado}">
                <CollectionView.ItemsLayout>
                    <LinearItemsLayout Orientation="Vertical" ItemSpacing="20" />
                </CollectionView.ItemsLayout>

                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:GastosYCostosDTO">
                        <Border
                            Padding="0"
                            BackgroundColor="White"
                            Stroke="#E5E7EB"
                            StrokeThickness="1">
                            <Border.StrokeShape>
                                <RoundRectangle CornerRadius="16" />
                            </Border.StrokeShape>

                            <Grid RowDefinitions="Auto,*,Auto">
                                <!-- Header del presupuesto -->
                                <Border
                                    Grid.Row="0"
                                    BackgroundColor="#D0B595"
                                    HeightRequest="70">
                                    <Border.StrokeShape>
                                        <RoundRectangle CornerRadius="16,16,0,0" />
                                    </Border.StrokeShape>
                                    <Grid
                                        Padding="20,15"
                                        ColumnDefinitions="*,Auto"
                                        ColumnSpacing="15">
                                        <HorizontalStackLayout
                                            Grid.Column="0"
                                            Spacing="10"
                                            VerticalOptions="Center">
                                            <Label
                                                FontAttributes="Bold"
                                                FontSize="20"
                                                Text="{Binding Costo.NombrePalletCliente}"
                                                TextColor="White"
                                                VerticalTextAlignment="Center" />
                                            <ImageButton
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PresupuestoMostrarViewModel}}, Path=MostrarPresupuestoCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent"
                                                HeightRequest="32"
                                                WidthRequest="32"
                                                VerticalOptions="Center">
                                                <ImageButton.Source>
                                                    <FontImageSource
                                                        FontFamily="FASolid"
                                                        Glyph="{x:Static fa:Solid.PenToSquare}"
                                                        Size="18"
                                                        Color="White" />
                                                </ImageButton.Source>
                                            </ImageButton>
                                        </HorizontalStackLayout>

                                        <HorizontalStackLayout
                                            Grid.Column="1"
                                            Spacing="8"
                                            HorizontalOptions="End"
                                            VerticalOptions="Center">
                                            <material:PickerField
                                                x:Name="MesPicker"
                                                Title="Mes"
                                                x:DataType="{x:Null}"
                                                AllowClear="False"
                                                BorderColor="#C9C9C9"
                                                BorderThickness="1"
                                                FontSize="11"
                                                HeightRequest="50"
                                                ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PresupuestoMostrarViewModel}}, Path=Meses}"
                                                SelectedIndex="{Binding MesToCopy, Mode=TwoWay}"
                                                WidthRequest="80" />
                                            <material:PickerField
                                                x:Name="AÃ±oPicker"
                                                Title="AÃ±o"
                                                x:DataType="{x:Null}"
                                                AllowClear="False"
                                                BorderColor="#C9C9C9"
                                                FontSize="11"
                                                HeightRequest="50"
                                                ItemsSource="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PresupuestoMostrarViewModel}}, Path=AÃ±os}"
                                                SelectedIndex="{Binding AÃ±oToCopyIndex, Mode=TwoWay}"
                                                WidthRequest="90" />
                                            <ImageButton
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PresupuestoMostrarViewModel}}, Path=CopiarPresupuestoCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="Transparent"
                                                HeightRequest="50"
                                                WidthRequest="50"
                                                HorizontalOptions="End"
                                                VerticalOptions="Center">
                                                <ImageButton.Source>
                                                    <FontImageSource
                                                        FontFamily="FASolid"
                                                        Glyph="{x:Static fa:Solid.ShareFromSquare}"
                                                        Size="20"
                                                        Color="White" />
                                                </ImageButton.Source>
                                            </ImageButton>
                                        </HorizontalStackLayout>
                                    </Grid>
                                </Border>

                                <!-- Contenido principal -->
                                <VerticalStackLayout Grid.Row="1" Padding="20,20" Spacing="15">
                                    <!-- Fecha y precio principal -->
                                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="15">
                                        <Label
                                            Grid.Column="0"
                                            FontSize="14"
                                            Text="{Binding Costo.Mes, StringFormat='ðŸ“… Mes: {0:MM/yyyy}'}"
                                            TextColor="#6B7280"
                                            VerticalOptions="Center" />
                                        <HorizontalStackLayout
                                            Grid.Column="1"
                                            Spacing="10"
                                            VerticalOptions="Center">
                                            <Label
                                                FontSize="14"
                                                Text="Precio:"
                                                TextColor="#6B7280"
                                                VerticalTextAlignment="Center" />
                                            <Editor
                                                FontSize="18"
                                                FontAttributes="Bold"
                                                HorizontalTextAlignment="End"
                                                Text="{Binding Costo.PrecioPallet}"
                                                TextColor="#059669"
                                                VerticalTextAlignment="Center"
                                                WidthRequest="100"
                                                BackgroundColor="#F0FDF4"
                                                HeightRequest="40" />
                                            <ImageButton
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:PresupuestoMostrarViewModel}}, Path=GuardarPrecioCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="#10B981"
                                                HeightRequest="40"
                                                WidthRequest="40"
                                                VerticalOptions="Center">
                                                <ImageButton.Source>
                                                    <FontImageSource
                                                        FontFamily="FASolid"
                                                        Glyph="{x:Static fa:Solid.FloppyDisk}"
                                                        Size="18"
                                                        Color="White" />
                                                </ImageButton.Source>
                                            </ImageButton>
                                        </HorizontalStackLayout>
                                    </Grid>

                                    <!-- MÃ©tricas principales en cards -->
                                    <Grid ColumnDefinitions="*,*,*" ColumnSpacing="12">
                                        <Border
                                            Grid.Column="0"
                                            Padding="15,12"
                                            BackgroundColor="#FEF3C7"
                                            Stroke="#FCD34D"
                                            StrokeThickness="1">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10" />
                                            </Border.StrokeShape>
                                            <VerticalStackLayout Spacing="5">
                                                <Label
                                                    FontSize="11"
                                                    Text="GANANCIA"
                                                    TextColor="#92400E"
                                                    FontAttributes="Bold" />
                                                <Label
                                                    FontSize="18"
                                                    FontAttributes="Bold"
                                                    Text="{Binding Costo.GananciaPorCantPallet, StringFormat='${0:N2}'}"
                                                    TextColor="#92400E" />
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border
                                            Grid.Column="1"
                                            Padding="15,12"
                                            BackgroundColor="#DBEAFE"
                                            Stroke="#60A5FA"
                                            StrokeThickness="1">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10" />
                                            </Border.StrokeShape>
                                            <VerticalStackLayout Spacing="5">
                                                <Label
                                                    FontSize="11"
                                                    Text="GANANCIA/CAMIÃ“N"
                                                    TextColor="#1E40AF"
                                                    FontAttributes="Bold" />
                                                <Label
                                                    FontSize="18"
                                                    FontAttributes="Bold"
                                                    Text="{Binding GananciaPorCamion, StringFormat='${0:N2}'}"
                                                    TextColor="#1E40AF" />
                                            </VerticalStackLayout>
                                        </Border>
                                        <Border
                                            Grid.Column="2"
                                            Padding="15,12"
                                            BackgroundColor="#F3E8FF"
                                            Stroke="#A78BFA"
                                            StrokeThickness="1">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10" />
                                            </Border.StrokeShape>
                                            <VerticalStackLayout Spacing="5">
                                                <Label
                                                    FontSize="11"
                                                    Text="COSTO FINAL"
                                                    TextColor="#6B21A8"
                                                    FontAttributes="Bold" />
                                                <Label
                                                    FontSize="18"
                                                    FontAttributes="Bold"
                                                    Text="{Binding CostoFinalPallet, StringFormat='${0:N2}'}"
                                                    TextColor="#6B21A8" />
                                            </VerticalStackLayout>
                                        </Border>
                                    </Grid>

                                    <!-- Detalles adicionales en grid organizado -->
                                    <Border
                                        Padding="15"
                                        BackgroundColor="#F9FAFB"
                                        Stroke="#E5E7EB"
                                        StrokeThickness="1">
                                        <Border.StrokeShape>
                                            <RoundRectangle CornerRadius="12" />
                                        </Border.StrokeShape>
                                        <Grid
                                            RowDefinitions="Auto,Auto,Auto"
                                            ColumnDefinitions="*,*,*"
                                            RowSpacing="12"
                                            ColumnSpacing="15">
                                            <Label
                                                Grid.Row="0"
                                                Grid.Column="0"
                                                FontSize="13"
                                                Text="{Binding Costo.CantidadPorDia, StringFormat='ðŸ“¦ Cantidad/dÃ­a: {0}'}"
                                                TextColor="#4B5563" />
                                            <Label
                                                Grid.Row="0"
                                                Grid.Column="1"
                                                FontSize="13"
                                                Text="{Binding Costo.HorasPorMes, StringFormat='â° Horas/mes: {0}'}"
                                                TextColor="#4B5563" />
                                            <Label
                                                Grid.Row="0"
                                                Grid.Column="2"
                                                FontSize="13"
                                                Text="{Binding TotalGasto.TotalGastoFijo, StringFormat='ðŸ’° Gasto Fijo: ${0:N2}'}"
                                                TextColor="#4B5563" />
                                            <Label
                                                Grid.Row="1"
                                                Grid.Column="0"
                                                FontSize="13"
                                                Text="{Binding CantDiasCamion, StringFormat='ðŸšš DÃ­as/CamiÃ³n: {0:N2}'}"
                                                TextColor="#4B5563" />
                                            <Label
                                                Grid.Row="1"
                                                Grid.Column="1"
                                                FontSize="13"
                                                Text="{Binding HacenPorMes, StringFormat='ðŸ“Š Cantidad/Mes: {0:N0}'}"
                                                TextColor="#4B5563" />
                                            <Label
                                                Grid.Row="1"
                                                Grid.Column="2"
                                                FontSize="13"
                                                Text="{Binding GastoDelPallet, StringFormat='ðŸ’µ Gasto Pallet: ${0:N2}'}"
                                                TextColor="#4B5563" />
                                            <Label
                                                Grid.Row="2"
                                                Grid.Column="0"
                                                Grid.ColumnSpan="3"
                                                FontSize="13"
                                                FontAttributes="Bold"
                                                Text="{Binding CostoTotalCamion, StringFormat='ðŸš› Costo por CamiÃ³n: ${0:N2}'}"
                                                TextColor="#1F2937" />
                                        </Grid>
                                    </Border>
                                </VerticalStackLayout>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </ScrollView>
    </Grid>
</ContentPage>
